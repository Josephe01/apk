{% extends "base.html" %}

{% block title %}Course Management - APK System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1><i class="fas fa-graduation-cap me-2"></i>Course Management</h1>
            <div>
                <button type="button" class="btn btn-success me-2" onclick="showAddCourseModal()">
                    <i class="fas fa-plus me-1"></i>Add Course
                </button>
                <div class="btn-group">
                    <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="exportCourses('json')">
                            <i class="fas fa-file-code me-1"></i>Export as JSON
                        </a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportCourses('csv')">
                            <i class="fas fa-file-csv me-1"></i>Export as CSV
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="searchInput" placeholder="Search courses..." onkeyup="filterCourses()">
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="statusFilter" onchange="filterCourses()">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="archived">Archived</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="departmentFilter" onchange="filterCourses()">
            <option value="">All Departments</option>
            <!-- Options will be populated dynamically -->
        </select>
    </div>
</div>

<!-- Courses Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="coursesTable">
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Name</th>
                        <th>Instructor</th>
                        <th>Department</th>
                        <th>Credits</th>
                        <th>Enrollment</th>
                        <th>Status</th>
                        <th>Start Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="coursesTableBody">
                    <!-- Courses will be loaded dynamically -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Course Modal -->
<div class="modal fade" id="courseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="courseModalTitle">Add Course</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="courseForm">
                    <input type="hidden" id="courseId">
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="courseName" class="form-label">Course Name *</label>
                                <input type="text" class="form-control" id="courseName" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="courseCode" class="form-label">Course Code *</label>
                                <input type="text" class="form-control" id="courseCode" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="courseDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="courseDescription" rows="3"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="courseInstructor" class="form-label">Instructor</label>
                                <input type="text" class="form-control" id="courseInstructor">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="courseDepartment" class="form-label">Department</label>
                                <input type="text" class="form-control" id="courseDepartment">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="courseCredits" class="form-label">Credits</label>
                                <input type="number" class="form-control" id="courseCredits" min="1" max="10" value="3">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="courseCapacity" class="form-label">Capacity</label>
                                <input type="number" class="form-control" id="courseCapacity" min="1" value="30">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="courseEnrolled" class="form-label">Enrolled</label>
                                <input type="number" class="form-control" id="courseEnrolled" min="0" value="0">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="courseStatus" class="form-label">Status</label>
                                <select class="form-select" id="courseStatus">
                                    <option value="active">Active</option>
                                    <option value="inactive">Inactive</option>
                                    <option value="archived">Archived</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="courseStartDate" class="form-label">Start Date</label>
                                <input type="datetime-local" class="form-control" id="courseStartDate">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="courseEndDate" class="form-label">End Date</label>
                                <input type="datetime-local" class="form-control" id="courseEndDate">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveCourse()">
                    <i class="fas fa-save me-1"></i>Save Course
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this course?</p>
                <p class="text-danger"><strong>This action cannot be undone.</strong></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash me-1"></i>Delete
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let courses = [];
let courseToDelete = null;

document.addEventListener('DOMContentLoaded', function() {
    loadCourses();
});

function loadCourses() {
    fetch('/api/courses')
        .then(response => response.json())
        .then(data => {
            courses = data;
            renderCourses();
            populateFilters();
        })
        .catch(error => {
            console.error('Error loading courses:', error);
            showNotification('Error loading courses', 'danger');
        });
}

function renderCourses() {
    const tbody = document.getElementById('coursesTableBody');
    tbody.innerHTML = '';
    
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const departmentFilter = document.getElementById('departmentFilter').value;
    
    const filteredCourses = courses.filter(course => {
        const matchesSearch = !searchTerm || 
            course.name.toLowerCase().includes(searchTerm) ||
            course.code.toLowerCase().includes(searchTerm) ||
            (course.instructor && course.instructor.toLowerCase().includes(searchTerm));
        const matchesStatus = !statusFilter || course.status === statusFilter;
        const matchesDepartment = !departmentFilter || course.department === departmentFilter;
        
        return matchesSearch && matchesStatus && matchesDepartment;
    });
    
    filteredCourses.forEach(course => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><code>${course.code}</code></td>
            <td>${course.name}</td>
            <td>${course.instructor || '-'}</td>
            <td>${course.department || '-'}</td>
            <td>${course.credits}</td>
            <td>
                <span class="badge ${course.enrolled > course.capacity ? 'bg-danger' : 'bg-success'}">
                    ${course.enrolled}/${course.capacity}
                </span>
            </td>
            <td>
                <span class="badge ${getStatusBadgeClass(course.status)}">${course.status.toUpperCase()}</span>
            </td>
            <td>${course.start_date ? new Date(course.start_date).toLocaleDateString() : '-'}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button type="button" class="btn btn-outline-primary" onclick="editCourse(${course.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger" onclick="deleteCourse(${course.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function getStatusBadgeClass(status) {
    switch(status) {
        case 'active': return 'bg-success';
        case 'inactive': return 'bg-secondary';
        case 'archived': return 'bg-warning';
        default: return 'bg-secondary';
    }
}

function populateFilters() {
    const departments = [...new Set(courses.map(course => course.department).filter(Boolean))];
    const departmentFilter = document.getElementById('departmentFilter');
    
    // Clear existing options except the first one
    departmentFilter.innerHTML = '<option value="">All Departments</option>';
    
    departments.forEach(department => {
        const option = document.createElement('option');
        option.value = department;
        option.textContent = department;
        departmentFilter.appendChild(option);
    });
}

function filterCourses() {
    renderCourses();
}

function showAddCourseModal() {
    document.getElementById('courseModalTitle').textContent = 'Add Course';
    document.getElementById('courseForm').reset();
    document.getElementById('courseId').value = '';
    new bootstrap.Modal(document.getElementById('courseModal')).show();
}

function editCourse(courseId) {
    const course = courses.find(c => c.id === courseId);
    if (!course) return;
    
    document.getElementById('courseModalTitle').textContent = 'Edit Course';
    document.getElementById('courseId').value = course.id;
    document.getElementById('courseName').value = course.name;
    document.getElementById('courseCode').value = course.code;
    document.getElementById('courseDescription').value = course.description || '';
    document.getElementById('courseInstructor').value = course.instructor || '';
    document.getElementById('courseDepartment').value = course.department || '';
    document.getElementById('courseCredits').value = course.credits;
    document.getElementById('courseCapacity').value = course.capacity;
    document.getElementById('courseEnrolled').value = course.enrolled;
    document.getElementById('courseStatus').value = course.status;
    
    if (course.start_date) {
        document.getElementById('courseStartDate').value = new Date(course.start_date).toISOString().slice(0, 16);
    }
    if (course.end_date) {
        document.getElementById('courseEndDate').value = new Date(course.end_date).toISOString().slice(0, 16);
    }
    
    new bootstrap.Modal(document.getElementById('courseModal')).show();
}

function saveCourse() {
    const courseId = document.getElementById('courseId').value;
    const isEdit = courseId !== '';
    
    const courseData = {
        name: document.getElementById('courseName').value,
        code: document.getElementById('courseCode').value,
        description: document.getElementById('courseDescription').value,
        instructor: document.getElementById('courseInstructor').value,
        department: document.getElementById('courseDepartment').value,
        credits: parseInt(document.getElementById('courseCredits').value),
        capacity: parseInt(document.getElementById('courseCapacity').value),
        enrolled: parseInt(document.getElementById('courseEnrolled').value),
        status: document.getElementById('courseStatus').value,
        start_date: document.getElementById('courseStartDate').value || null,
        end_date: document.getElementById('courseEndDate').value || null
    };
    
    const url = isEdit ? `/api/courses/${courseId}` : '/api/courses';
    const method = isEdit ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(courseData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('courseModal')).hide();
            loadCourses();
        } else {
            showNotification(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error saving course:', error);
        showNotification('Error saving course', 'danger');
    });
}

function deleteCourse(courseId) {
    courseToDelete = courseId;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

function confirmDelete() {
    if (!courseToDelete) return;
    
    fetch(`/api/courses/${courseToDelete}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(data.message, 'success');
            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            loadCourses();
        } else {
            showNotification(data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error deleting course:', error);
        showNotification('Error deleting course', 'danger');
    });
    
    courseToDelete = null;
}

function exportCourses(format) {
    window.location.href = `/api/courses/export?format=${format}`;
}

function showNotification(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('main');
    container.insertBefore(alertDiv, container.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}